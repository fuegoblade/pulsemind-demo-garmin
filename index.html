<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PulseMind™ Demo — Garmin Integration</title>
  <style>
    :root{
      --bg:#0b0c0d;
      --card:#121417;
      --ink:#f5f7fa;
      --muted:#98a2ad;
      --accent:#00a3ff;       /* Garmin blue */
      --pm:#bf00ff;           /* PulseMind purple */
      --border:#1f2328;
      --chip:#0e1b22;
      --ink-soft:#cfd6de;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      line-height:1.45;
    }
    .wrap{max-width:980px;margin:20px auto 48px;padding:0 16px}
    /* --- Sticky header with logos --- */
    .sticky{
      position:sticky;top:0;z-index:10;
      backdrop-filter:saturate(140%) blur(8px);
      background:linear-gradient(to bottom, rgba(11,12,13,.85), rgba(11,12,13,.6));
      border-bottom:1px solid var(--border);
    }
    .brand{
      display:flex;align-items:center;justify-content:space-between;
      gap:16px;padding:10px 16px;
    }
    .brand .left, .brand .right{display:flex;align-items:center;gap:12px}
    .garmin-logo{height:36px;display:block;margin-inline:auto}
    .pm-chip{
      font-weight:800;color:var(--pm);letter-spacing:.2px;
    }
    .cta{
      padding:10px 14px;border-radius:10px;border:1px solid #0a3a57;
      background:var(--accent);color:#001018;font-weight:800;cursor:pointer;
    }
    .cta:active{transform:translateY(1px)}

    h1{font-size:28px;margin:14px 0 8px}
    .badge{display:inline-block;font-size:12px;padding:3px 8px;border-radius:999px;
      border:1px solid var(--border);background:var(--chip);color:var(--muted);margin-left:8px}
    p.small{color:var(--muted);margin:6px 0 18px}
    a{color:var(--accent);text-decoration:none}
    a.pm{color:var(--pm)}

    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin:18px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1 1 260px}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#101418;color:var(--ink);cursor:pointer}
    button.primary{background:var(--accent);border-color:#0597ea;color:#001018;font-weight:800}
    button:active{transform:translateY(1px)}
    label.file{display:inline-block;padding:10px 14px;border-radius:10px;border:1px dashed var(--border);cursor:pointer;background:#0d1013}
    input[type=file]{display:none}
    textarea{width:100%;min-height:220px;background:#0d0f12;border:1px solid var(--border);border-radius:10px;color:var(--ink);padding:10px;font-family:ui-monospace,Menlo,Consolas}
    .kpis{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:12px}
    .kpi{padding:14px;border-radius:10px;border:1px solid var(--border);background:#0e1014}
    .kpi .label{color:var(--muted);font-size:12px;margin-bottom:4px}
    .kpi .value{font-size:28px;font-weight:800}
    .switches{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .chip{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#0d1014;color:var(--ink-soft)}
    pre{white-space:pre-wrap;background:#0d0f12;border:1px solid var(--border);border-radius:10px;color:#cdd6e1;padding:12px;overflow:auto}
    footer{color:var(--muted);text-align:center;margin:28px 0}
  </style>
</head>
<body>
  <!-- Sticky header with Garmin logo centered and a Connect button on the right -->
  <div class="sticky">
    <div class="brand">
      <div class="left">
        <span class="pm-chip">PulseMind™</span>
      </div>
      <a href="https://www.garmin.com" target="_blank" rel="noopener" aria-label="Garmin">
        <img class="garmin-logo" src="assets/garmin-logo.png" alt="Garmin Logo" />
      </a>
      <div class="right">
        <button class="cta" onclick="alert('OAuth is off in the demo build. This is a UX preview.');">
          Connect with Garmin
        </button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <h1>PulseMind™ Demo — Garmin Integration <span class="badge">Garmin Preview</span></h1>
    <p class="small">
      Concept demo with simplified logic. No proprietary model weights or production logic are included.
    </p>

    <p class="small" style="font-size:13px;color:#cfd6de">
      Data source:
      <a href="https://connect.garmin.com" target="_blank" rel="noopener">Garmin Connect</a>
      • Analysis by
      <a class="pm" href="https://fuegoblade.com" target="_blank" rel="noopener">PulseMind™</a>
    </p>

    <!-- 1) DATA: Load from live API or upload JSON -->
    <div class="card">
      <h2>1) Data</h2>
      <div class="row">
        <div>
          <p class="small">Pull live sample from the demo API or upload your own JSON with fields:
            <code>date, hr_rest, rmssd, sleep_hours, load</code>.
          </p>
          <div class="row">
            <button id="fetchApi" class="primary">Load from /api/garmin/latest</button>
            <label class="file">
              <input id="file" type="file" accept=".json,application/json">
              Upload JSON…
            </label>
            <button id="clear">Clear</button>
          </div>
        </div>
      </div>
      <textarea id="json" placeholder='[{"date":"2025-08-25","hr_rest":52,"rmssd":58,"sleep_hours":7.2,"load":320}, …]'></textarea>
    </div>

    <!-- 2) EVALUATE: Readiness & Risk -->
    <div class="card">
      <h2>2) Evaluate</h2>
      <p class="small">Runs a simplified readiness & overload mock. You can toggle scenarios to preview PulseMind’s live adjustments.</p>

      <div class="switches">
        <label class="chip"><input id="swFlu" type="checkbox"> Flu (temporary stressor)</label>
        <label class="chip"><input id="swSleepDebt" type="checkbox"> Sleep Debt (-10%)</label>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="eval" class="primary">Evaluate</button>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="label">Readiness Score</div>
          <div id="ready" class="value">—</div>
        </div>
        <div class="kpi">
          <div class="label">Overload Risk</div>
          <div id="risk" class="value">—</div>
        </div>
      </div>

      <h2 style="margin-top:16px;">Notes</h2>
      <ul class="small">
        <li><strong>Readiness</strong>: 0–100 (higher = better). Built from HRV, sleep, and recent training load.</li>
        <li><strong>Risk</strong>: Low / Moderate / High from acute:chronic load and HRV drift.</li>
        <li>Scenario switches let reviewers see how transient factors would affect guidance.</li>
      </ul>
    </div>

    <!-- Debug -->
    <div class="card">
      <h2>Debug Output</h2>
      <pre id="log">Ready.</pre>
    </div>

    <footer>© PulseMind™ Demo • Private Garmin preview • For evaluation only.</footer>
  </div>

  <script>
    // --- Helpers ---
    const $ = s => document.querySelector(s);
    const log = msg => { $('#log').textContent = (typeof msg === 'string') ? msg : JSON.stringify(msg, null, 2); };
    const setKPIs = (r, k) => { $('#ready').textContent = r; $('#risk').textContent = k; };

    // Client-side evaluator (fallback when we only have raw "data" array)
    function evaluateFromData(data){
      const n = data.length || 1;
      const avg = arr => arr.reduce((a,b)=>a+b,0) / (arr.length||1);

      const hrvs   = data.map(d => +d.rmssd);
      const sleeps = data.map(d => +d.sleep_hours);
      const loads  = data.map(d => +d.load);

      const hrvAvg   = avg(hrvs);
      const sleepAvg = avg(sleeps);
      const loadSum  = loads.reduce((a,b)=>a+b,0);

      const norm = (x,min,max) => Math.max(0, Math.min(1, (x-min)/(max-min)));
      let readiness = Math.round(100 * (
        0.45 * norm(hrvAvg, 30, 100) +
        0.35 * norm(sleepAvg, 5, 9) +
        0.20 * (1 - norm(loadSum/n, 150, 600))
      ));

      const k = Math.min(7, n);
      const recent  = loads.slice(-k);
      const acute   = avg(recent);
      const chronic = avg(loads);
      const ratio   = chronic > 0 ? acute / chronic : 0;
      const hrvDrift = (hrvs[hrvs.length-1] ?? hrvAvg) - hrvAvg;

      let risk = "Low";
      if (ratio > 1.3 || hrvDrift < -5)  risk = "Moderate";
      if (ratio > 1.6 || hrvDrift < -10) risk = "High";

      return { readiness, risk, details: { hrvAvg, sleepAvg, loadAvg: avg(loads), ratio, hrvDrift } };
    }

    // Apply scenario switches to readiness (for demo wow-effect)
    function applyScenarios(readiness){
      let r = readiness;
      if ($('#swFlu').checked)       r = Math.max(0, r - 20);
      if ($('#swSleepDebt').checked) r = Math.max(0, Math.round(r * 0.90));
      return r;
    }

    // --- Actions ---
    $('#fetchApi').onclick = async () => {
      try{
        const res = await fetch('/api/garmin/latest');
        const data = await res.json();
        // The API now returns either {ok, summary, details, data} OR a raw array.
        const payload = (Array.isArray(data)) ? data : (data.data || []);
        $('#json').value = JSON.stringify(payload, null, 2);

        // If summary exists from API, show it immediately
        if (!Array.isArray(data) && data.summary){
          const adj = applyScenarios(data.summary.readiness);
          setKPIs(adj, data.summary.risk);
          log(data);
        } else {
          setKPIs('—','—');
          log({note:'Loaded raw data from API. Press Evaluate to compute.'});
        }
      }catch(e){
        setKPIs('—','—'); log('Fetch failed: ' + e.message);
      }
    };

    $('#file').onchange = e => {
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = () => $('#json').value = r.result;
      r.readAsText(f);
      setKPIs('—','—');
      log('JSON loaded from file.');
    };

    $('#clear').onclick = () => {
      $('#json').value = '';
      setKPIs('—','—');
      log('Cleared.');
    };

    $('#eval').onclick = () => {
      try{
        const txt = $('#json').value.trim();
        if (!txt) { log('No JSON loaded. Use the API button or upload a file.'); return; }
        const arr = JSON.parse(txt);
        const out = evaluateFromData(arr);
        const adjusted = applyScenarios(out.readiness);
        setKPIs(adjusted, out.risk);
        log({ from: 'client-eval', adjustedReadiness: adjusted, ...out });
      }catch(err){
        setKPIs('—','—'); log('Invalid JSON: ' + err.message);
      }
    };
  </script>
</body>
</html>
