<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PulseMind™ Demo — Garmin Integration</title>
  <style>
    :root{
      --bg:#0b0c0d; --card:#121417; --ink:#f5f7fa; --muted:#98a2ad;
      --accent:#007CC3;  /* Garmin blue */
      --pm:#BF00FF;      /* PulseMind purple */
      --border:#1f2328; --chip:#0e1b22;
      --ok:#19c37d; --mid:#f5a524; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;line-height:1.45}
    .wrap{max-width:1000px;margin:24px auto 40px;padding:0 16px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:26px}
    .pm{color:var(--pm);font-weight:800}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#101418;color:var(--ink);cursor:pointer}
    .btn.primary{background:var(--accent);border-color:#0597ea;color:#001018;font-weight:800}
    .btn:active{transform:translateY(1px)}
    h1{font-size:28px;margin:14px 0 6px}
    .badge{display:inline-block;font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:var(--chip);color:var(--muted);margin-left:8px}
    p.small{color:var(--muted);margin:6px 0 18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin:16px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1 1 260px}
    textarea{width:100%;min-height:220px;background:#0d0f12;border:1px solid var(--border);border-radius:10px;color:#cfe3ff;padding:10px;font-family:ui-monospace,Menlo,Consolas}
    label.file{display:inline-block;padding:10px 14px;border-radius:10px;border:1px dashed var(--border);cursor:pointer;background:#0d1013}
    input[type=file]{display:none}
    .kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:12px}
    .kpi{padding:14px;border-radius:10px;border:1px solid var(--border);background:#0e1014}
    .kpi .label{color:var(--muted);font-size:12px;margin-bottom:4px}
    .kpi .value{font-size:26px;font-weight:900}
    .ok .value{color:var(--ok)} .mid .value{color:var(--mid)} .bad .value{color:var(--bad)}
    h2{font-size:18px;margin:0 0 8px}
    ul.small{color:var(--muted);padding-left:18px;margin:6px 0}
    pre{white-space:pre-wrap;background:#0d0f12;border:1px solid var(--border);border-radius:10px;color:#cdd6e1;padding:12px;overflow:auto}
    footer{color:var(--muted);text-align:center;margin:20px 0}
    a{color:var(--accent);text-decoration:none}
    a.pm{color:var(--pm)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <img src="assets/garmin-logo.png" alt="Garmin Logo" />
        <span class="pm">PulseMind™</span>
      </div>
      <!-- až napojíme, změníme href na /api/oauth/start -->
      <a class="btn primary" href="/api/oauth/start">Connect with Garmin</a>
    </div>

    <h1>PulseMind™ Demo <span class="badge">Garmin Preview</span></h1>
    <p class="small">
      Data source:
      <a href="https://connect.garmin.com" target="_blank" rel="noopener">Garmin Connect</a>
      • Analysis by
      <a class="pm" href="https://fuegoblade.com" target="_blank" rel="noopener">PulseMind™</a>
    </p>

    <!-- 1) Data -->
    <div class="card">
      <h2>1) Load data</h2>
      <p class="small">Use sample or upload your JSON with fields:
        <code>date, hr_rest, rmssd, sleep_hours, load</code>.
      </p>
      <div class="row">
        <button id="loadSample" class="btn">Load sample_week.json</button>
        <button id="loadLive" class="btn">Load from Garmin (live)</button>
        <label class="file"><input id="file" type="file" accept=".json,application/json">Upload JSON…</label>
        <button id="clear" class="btn">Clear</button>
      </div>
      <textarea id="json" placeholder='[{"date":"2025-08-25","hr_rest":52,"rmssd":58,"sleep_hours":7.2,"load":320}, …]'></textarea>
    </div>

    <!-- 2) AI Evaluate -->
    <div class="card">
      <h2>2) PulseMind™ AI Evaluate</h2>
      <p class="small">Contextual scoring + coaching preview. Not final production logic.</p>
      <div class="row">
        <button id="eval" class="btn primary">Evaluate</button>
      </div>

      <div class="kpis">
        <div class="kpi" id="kpi-ready">
          <div class="label">Readiness</div>
          <div id="ready" class="value">—</div>
        </div>
        <div class="kpi" id="kpi-risk">
          <div class="label">Overload Risk</div>
          <div id="risk" class="value">—</div>
        </div>
        <div class="kpi" id="kpi-sleep">
          <div class="label">Sleep Deficit (7d)</div>
          <div id="sleepDef" class="value">—</div>
        </div>
        <div class="kpi" id="kpi-flu">
          <div class="label">Flu-like Risk</div>
          <div id="fluRisk" class="value">—</div>
        </div>
        <div class="kpi" id="kpi-window">
          <div class="label">Recovery Window</div>
          <div id="window" class="value">—</div>
        </div>
        <div class="kpi" id="kpi-trend">
          <div class="label">HRV Trend</div>
          <div id="hrvTrend" class="value">—</div>
        </div>
      </div>

      <h2 style="margin-top:16px;">Coach Notes</h2>
      <pre id="advice">Load data and press Evaluate.</pre>

      <h2 style="margin-top:16px;">What the AI looks at</h2>
      <ul class="small">
        <li><b>Readiness:</b> HRV baseline vs. recent, sleep quantity, inverse of short-term load.</li>
        <li><b>Overload:</b> ACWR + HRV drift (protects from silent overreaching).</li>
        <li><b>Sleep deficit:</b> vs. 8h target over last 7 days.</li>
        <li><b>Flu-like risk:</b> HRV drop + RHR rise vs. 14d baseline.</li>
        <li><b>Recovery window:</b> easy/tempo/hard guidance for the next 24–48h.</li>
      </ul>
    </div>

    <!-- Debug -->
    <div class="card">
      <h2>Debug</h2>
      <pre id="log">Ready.</pre>
    </div>

    <footer>© 2025 Fuego & Blade™ • PulseMind™ Demo for Garmin (evaluation only).</footer>
  </div>

  <script>
    // helpers
    const avg=a=>a.reduce((x,y)=>x+y,0)/(a.length||1);
    const clamp01=x=>Math.max(0,Math.min(1,x));
    const el=id=>document.getElementById(id);
    const set=(id,val)=>el(id).textContent=val;
    const klass=(id,k)=>{const n=document.getElementById(id); n.classList.remove('ok','mid','bad'); if(k) n.classList.add(k)}
    const by=k=>d=>+d[k];

    // fallback sample
    const sample = [
      {"date":"2025-08-25","hr_rest":52,"rmssd":58,"sleep_hours":7.2,"load":320},
      {"date":"2025-08-26","hr_rest":51,"rmssd":61,"sleep_hours":7.6,"load":290},
      {"date":"2025-08-27","hr_rest":53,"rmssd":55,"sleep_hours":6.9,"load":410},
      {"date":"2025-08-28","hr_rest":50,"rmssd":62,"sleep_hours":7.8,"load":180},
      {"date":"2025-08-29","hr_rest":52,"rmssd":57,"sleep_hours":7.1,"load":260},
      {"date":"2025-08-30","hr_rest":54,"rmssd":52,"sleep_hours":6.4,"load":520},
      {"date":"2025-08-31","hr_rest":51,"rmssd":60,"sleep_hours":7.5,"load":230}
    ];

    function evaluate(data){
      // sort by date if possible
      try{ data=data.slice().sort((a,b)=>new Date(a.date)-new Date(b.date)); }catch{}

      const n=data.length||1;
      const hr=data.map(by('hr_rest'));
      const hrv=data.map(by('rmssd'));
      const slp=data.map(by('sleep_hours'));
      const lds=data.map(by('load'));

      const hrvAvg=avg(hrv), sleepAvg=avg(slp), loadAvg=avg(lds);

      // readiness 0..100
      const readiness=Math.round(100*(0.45*clamp01((hrvAvg-30)/(100-30))
                                    +0.35*clamp01((sleepAvg-5)/(9-5))
                                    +0.20*(1-clamp01((loadAvg-150)/(600-150)))));

      // overload via ACWR + HRV drift
      const k=Math.min(7,n), acute=avg(lds.slice(-k)), chronic=avg(lds)||1;
      const ratio=acute/chronic;
      const hrvDrift=(hrv[hrv.length-1]??hrvAvg)-hrvAvg;
      let risk="Low", riskClass="ok";
      if(ratio>1.3||hrvDrift<-5){risk="Moderate";riskClass="mid"}
      if(ratio>1.6||hrvDrift<-10){risk="High";riskClass="bad"}

      // sleep deficit (7d vs 8h)
      const s7=slp.slice(-7).reduce((a,b)=>a+b,0);
      const sleepDef=+(7*8 - s7).toFixed(1); // + = debt

      // flu-like proxy: HRV drop + HR rise (last3 vs base14)
      const baseN=Math.min(14,n);
      const baseHRV=avg(hrv.slice(-baseN)), baseHR=avg(hr.slice(-baseN));
      const last3HRV=avg(hrv.slice(-3)), last3HR=avg(hr.slice(-3));
      const dropHRV=((baseHRV-last3HRV)/(baseHRV||1))*100; // %
      const riseHR=last3HR-baseHR;
      let flu="Low", fluClass="ok";
      if(dropHRV>10 && riseHR>2){flu="Moderate";fluClass="mid"}
      if(dropHRV>18 && riseHR>4){flu="High";fluClass="bad"}

      // recovery window (very simple)
      let window="Easy";
      if(risk==="High"||flu==="High"||sleepDef>4) window="Rest";
      else if(risk==="Moderate"||flu==="Moderate"||sleepDef>2) window="Easy–Tempo";
      const windowClass = window==="Rest" ? "bad" : (window==="Easy–Tempo"?"mid":"ok");

      // trend
      const first=Math.max(0,hrv.length-7);
      const trend = hrv.length>1 ? (hrv[hrv.length-1]-hrv[first]) : 0; // last vs ~week start
      const trendTxt = (trend>0?"+":"") + trend.toFixed(1);

      // advice text
      let tips=[];
      if(sleepDef>2) tips.push(`Sleep focus: ~${sleepDef}h debt vs 8h target.`);
      if(risk!=="Low") tips.push(`Load: ACWR ${ratio.toFixed(2)}, HRV drift ${hrvDrift.toFixed(1)}.`);
      if(flu!=="Low") tips.push(`Wellness: HRV -${dropHRV.toFixed(0)}%, RHR +${riseHR.toFixed(1)} bpm.`);
      tips.push(`Recommended next 24–48h: ${window}.`);

      return {readiness,risk,riskClass,sleepDef,flu,fluClass,window,windowClass,trendTxt};
    }

    // wiring
    const $ = s => document.querySelector(s);
    $('#loadSample').onclick = ()=>{ el('json').value = JSON.stringify(sample,null,2); };
    $('#clear').onclick = ()=>{ el('json').value=''; ['ready','risk','sleepDef','fluRisk','window','hrvTrend','advice','log'].forEach(id=>set(id,'')); ['kpi-ready','kpi-risk','kpi-sleep','kpi-flu','kpi-window','kpi-trend'].forEach(id=>klass(id,null)); set('log','Cleared.') };
    $('#file').onchange = e => { const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=> el('json').value=r.result; r.readAsText(f) };
    $('#eval').onclick = ()=>{
      try{
        const data=JSON.parse(el('json').value||'[]');
        const o=evaluate(data);
        set('ready',o.readiness);  klass('kpi-ready', o.readiness>=70?'ok':o.readiness>=50?'mid':'bad');
        set('risk',o.risk);        klass('kpi-risk', o.riskClass);
        set('sleepDef',(o.sleepDef>=0?'+':'')+o.sleepDef+'h'); klass('kpi-sleep', o.sleepDef>2?'bad':o.sleepDef>0.5?'mid':'ok');
        set('fluRisk',o.flu);      klass('kpi-flu', o.fluClass);
        set('window',o.window);    klass('kpi-window', o.windowClass);
        set('hrvTrend',o.trendTxt);klass('kpi-trend', o.trendTxt.startsWith('+')?'ok':o.trendTxt==='0.0'?'mid':'bad');
        set('advice',
`• Readiness: ${o.readiness}
• Load risk: ${o.risk}
• Sleep debt: ${(o.sleepDef>=0?'+':'')+o.sleepDef}h
• Flu-proxy: ${o.flu}
• HRV trend: ${o.trendTxt}
• Plan: ${o.window}`);
        set('log','OK');
      }catch(err){ set('log','Invalid JSON: '+err.message); }
    };

    // Live (server endpoint – zatím mock)
    $('#loadLive').onclick = async ()=>{
      try{
        set('log','Loading from /api/garmin/latest …');
        const r = await fetch('/api/garmin/latest',{cache:'no-store'});
        const j = await r.json();
        if(!r.ok) throw new Error(j && (j.error||j.detail) || r.statusText);
        el('json').value = JSON.stringify(j,null,2);
        set('log','Live data loaded.');
      }catch(e){ set('log','Live load failed: '+e.message); }
    };
  </script>
</body>
</html>
